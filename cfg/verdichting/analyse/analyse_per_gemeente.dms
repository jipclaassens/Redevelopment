container Analyse_per_gem
{
	unit<spoint> NL_grid_domain_rel := NL_grid/domain
	{
		attribute</BronData/begenzing_bebouwd_gebied/BBG_2000/shapes>   bbg      := poly2grid(/BronData/begenzing_bebouwd_gebied/BBG_2000/shapes/geometry, NL_grid/domain);
		attribute<Brondata/regios/gemeenten/gem_2012/gem_uq>  gem_2012 := poly2grid(Brondata/regios/gemeenten/gem_2012/gem_uq/geometry, NL_grid/domain);
	}

	container type_woonpand_in_bbg :=
		for_each_nedv(
			typeringen/type_woonpand/name 
			, 'isDefined(NL_grid_domain_rel/bbg) ? Brondata/BAG/snapshots/vbos/vbo2017/metwoonfunctie_enCBSStatus/type_woonpand/' + typeringen/type_woonpand/name + ' : 0'
			, NL_grid/domain
			, uint32
		);

	parameter<uint32> treshold := 20;

	container type_woonpand_gem :=
		for_each_nedv(
			typeringen/type_woonpand/name 
			, 'sum(type_woonpand_in_bbg/' + typeringen/type_woonpand/name + ' > treshold ? type_woonpand_in_bbg/' + typeringen/type_woonpand/name + ' : 0, NL_grid_domain_rel/gem_2012)'
			, Brondata/regios/gemeenten/gem_2012/gem_uq
			, uint32
		)
	{
		attribute<uint32> totaal (Brondata/regios/gemeenten/gem_2012/gem_uq) := ='add(' + AsItemList(typeringen/type_woonpand/name) + ')';
	}

	container aantal_cellen_type_woonpand_gem :=
		for_each_nedv(
			typeringen/type_woonpand/name 
			, 'sum(type_woonpand_in_bbg/' + typeringen/type_woonpand/name + ' > treshold ? 1 : 0, NL_grid_domain_rel/gem_2012)'
			, Brondata/regios/gemeenten/gem_2012/gem_uq
			, uint32
		)
	{
		attribute<uint32> totaal (Brondata/regios/gemeenten/gem_2012/gem_uq) := ='add(' + AsItemList(typeringen/type_woonpand/name) + ')';
	}
	
	container aantal_type_woonpand_per_cel_met_threshold 
	{
		attribute<string>  gem_label (Brondata/regios/gemeenten/gem_2012/gem_uq)     := Brondata/regios/gemeenten/gem_2012/gem_uq/label ;
		attribute<float32> app_per_ha    (Brondata/regios/gemeenten/gem_2012/gem_uq) := div(float32(Analyse_per_gem/type_woonpand_gem/appartement), float32(Analyse_per_gem/aantal_cellen_type_woonpand_gem/appartement));
		attribute<float32> vrij_per_ha   (Brondata/regios/gemeenten/gem_2012/gem_uq) := div(float32(Analyse_per_gem/type_woonpand_gem/vrijstaand), float32(Analyse_per_gem/aantal_cellen_type_woonpand_gem/vrijstaand));
		attribute<float32> tweeo1_per_ha (Brondata/regios/gemeenten/gem_2012/gem_uq) := div(float32(Analyse_per_gem/type_woonpand_gem/twee_onder_1_kap), float32(Analyse_per_gem/aantal_cellen_type_woonpand_gem/twee_onder_1_kap));
		attribute<float32> rij_per_ha    (Brondata/regios/gemeenten/gem_2012/gem_uq) := div(float32(Analyse_per_gem/type_woonpand_gem/rijtjeswoning), float32(Analyse_per_gem/aantal_cellen_type_woonpand_gem/rijtjeswoning));
		attribute<float32> totaal        (Brondata/regios/gemeenten/gem_2012/gem_uq) := (app_per_ha + vrij_per_ha + tweeo1_per_ha + rij_per_ha) / float32(4);
	}
	
	container bruto_gem
	{
	
		container bruto_gem_Y2012 :=
			for_each_nedv(
				typeringen/type_woonpand/name 
				, 'sum(Brondata/BAG/snapshots/vbos/vbo2012/metwoonfunctie_enCBSStatus/type_woonpand/' + typeringen/type_woonpand/name + ' [int32]> 0[int32] ? Brondata/BAG/snapshots/vbos/vbo2012/metwoonfunctie_enCBSStatus/type_woonpand/' + typeringen/type_woonpand/name + '[int32]: 0[int32], NL_grid_domain_rel/gem_2012)'
				, Brondata/regios/gemeenten/gem_2012/gem_uq
				, eenheden/nrwoningen
			)
		{
			attribute<string> gem_label (Brondata/regios/gemeenten/gem_2012/gem_uq) := Brondata/regios/gemeenten/gem_2012/gem_uq/label ;
			attribute<eenheden/nrwoningen> totaal (Brondata/regios/gemeenten/gem_2012/gem_uq)    := ='add(' + AsItemList(typeringen/type_woonpand/name) + ')';
		}

		container bruto_gem_Y2013 :=
			for_each_nedv(
				typeringen/type_woonpand/name 
				, 'sum(Brondata/BAG/snapshots/vbos/vbo2013/metwoonfunctie_enCBSStatus/type_woonpand/' + typeringen/type_woonpand/name + ' [int32]> 0[int32] ? Brondata/BAG/snapshots/vbos/vbo2013/metwoonfunctie_enCBSStatus/type_woonpand/' + typeringen/type_woonpand/name + '[int32]: 0[int32], NL_grid_domain_rel/gem_2012)'
				, Brondata/regios/gemeenten/gem_2012/gem_uq
				, eenheden/nrwoningen
			)
		{
			attribute<string> gem_label (Brondata/regios/gemeenten/gem_2012/gem_uq) := Brondata/regios/gemeenten/gem_2012/gem_uq/label ;
			attribute<eenheden/nrwoningen> totaal (Brondata/regios/gemeenten/gem_2012/gem_uq)    := ='add(' + AsItemList(typeringen/type_woonpand/name) + ')';
		}

		container bruto_gem_Y2014 :=
			for_each_nedv(
				typeringen/type_woonpand/name 
				, 'sum(Brondata/BAG/snapshots/vbos/vbo2014/metwoonfunctie_enCBSStatus/type_woonpand/' + typeringen/type_woonpand/name + ' [int32]> 0[int32] ? Brondata/BAG/snapshots/vbos/vbo2014/metwoonfunctie_enCBSStatus/type_woonpand/' + typeringen/type_woonpand/name + '[int32]: 0[int32], NL_grid_domain_rel/gem_2012)'
				, Brondata/regios/gemeenten/gem_2012/gem_uq
				, eenheden/nrwoningen
			)
		{
			attribute<string> gem_label (Brondata/regios/gemeenten/gem_2012/gem_uq) := Brondata/regios/gemeenten/gem_2012/gem_uq/label ;
			attribute<eenheden/nrwoningen> totaal (Brondata/regios/gemeenten/gem_2012/gem_uq)    := ='add(' + AsItemList(typeringen/type_woonpand/name) + ')';
		}

		container bruto_gem_Y2015 :=
			for_each_nedv(
				typeringen/type_woonpand/name 
				, 'sum(Brondata/BAG/snapshots/vbos/vbo2015/metwoonfunctie_enCBSStatus/type_woonpand/' + typeringen/type_woonpand/name + '[int32] > 0[int32] ? Brondata/BAG/snapshots/vbos/vbo2015/metwoonfunctie_enCBSStatus/type_woonpand/' + typeringen/type_woonpand/name + '[int32]: 0[int32], NL_grid_domain_rel/gem_2012)'
				, Brondata/regios/gemeenten/gem_2012/gem_uq
				, eenheden/nrwoningen
			)
		{
			attribute<string> gem_label (Brondata/regios/gemeenten/gem_2012/gem_uq) := Brondata/regios/gemeenten/gem_2012/gem_uq/label ;
			attribute<eenheden/nrwoningen> totaal (Brondata/regios/gemeenten/gem_2012/gem_uq)    := ='add(' + AsItemList(typeringen/type_woonpand/name) + ')';
		}

		container bruto_gem_Y2016 :=
			for_each_nedv(
				typeringen/type_woonpand/name 
				, 'sum(Brondata/BAG/snapshots/vbos/vbo2016/metwoonfunctie_enCBSStatus/type_woonpand/' + typeringen/type_woonpand/name + ' [int32]> 0[int32] ? Brondata/BAG/snapshots/vbos/vbo2016/metwoonfunctie_enCBSStatus/type_woonpand/' + typeringen/type_woonpand/name + '[int32]: 0[int32], NL_grid_domain_rel/gem_2012)'
				, Brondata/regios/gemeenten/gem_2012/gem_uq
				, eenheden/nrwoningen
			)
		{
			attribute<string> gem_label (Brondata/regios/gemeenten/gem_2012/gem_uq) := Brondata/regios/gemeenten/gem_2012/gem_uq/label ;
			attribute<eenheden/nrwoningen> totaal (Brondata/regios/gemeenten/gem_2012/gem_uq)    := ='add(' + AsItemList(typeringen/type_woonpand/name) + ')';
		}

		container bruto_gem_Y2017 :=
			for_each_nedv(
				typeringen/type_woonpand/name 
				, 'sum(Brondata/BAG/snapshots/vbos/vbo2017/metwoonfunctie_enCBSStatus/type_woonpand/' + typeringen/type_woonpand/name + '[int32] > 0[int32] ? Brondata/BAG/snapshots/vbos/vbo2017/metwoonfunctie_enCBSStatus/type_woonpand/' + typeringen/type_woonpand/name + '[int32]: 0[int32], NL_grid_domain_rel/gem_2012)'
				, Brondata/regios/gemeenten/gem_2012/gem_uq
				, eenheden/nrwoningen
			)
		{
			attribute<string> gem_label (Brondata/regios/gemeenten/gem_2012/gem_uq) := Brondata/regios/gemeenten/gem_2012/gem_uq/label ;
			attribute<eenheden/nrwoningen> totaal (Brondata/regios/gemeenten/gem_2012/gem_uq) := ='add(' + AsItemList(typeringen/type_woonpand/name) + ')';
		}
		
		
		container woning_aantallen_per_gem_per_type := 
			for_each_ne(
				/PandtypeTimeUnit/name
				, 'Templ('+string(id(/PandtypeTimeUnit))+'[/PandtypeTimeUnit])');
		
		template templ
		{
			//
			parameter</PandtypeTimeUnit> id;
			//
			
			parameter<string> PandtypeName := /PandtypeTimeUnit/PandtypeName[id];
			parameter<string> TimeName := /PandtypeTimeUnit/TimeName[id];
			
			attribute<eenheden/nrwoningen> Woningen (Brondata/regios/gemeenten/gem_2012/gem_uq) := = 'Analyse/Analyse_per_gem/bruto_gem/bruto_gem_'+TimeName+'/'+PandtypeName;

		}
	}

	
	container vbo_point_per_gem
	{
		attribute<string>    gem_naam (Brondata/regios/gemeenten/gem_2012/gem_uq) := BronData/regios/gemeenten/gem_2012/gem_uq/name;
		attribute<uint32>  gem_2012  (Brondata/regios/gemeenten/gem_2012/gem_uq) := pcount(BronData/BAG/snapshots/vbos/vbo2012/metwoonfunctie_enCBSStatus/gem_rel);
	}
}
